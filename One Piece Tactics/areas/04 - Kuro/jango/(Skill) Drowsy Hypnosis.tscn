[gd_scene load_steps=6 format=2]

[ext_resource path="res://skills/HelperWindows/Push.tscn" type="PackedScene" id=1]
[ext_resource path="res://areas/04 - Kuro/jango/hypno.tscn" type="PackedScene" id=2]
[ext_resource path="res://skills/SkillScript.gd" type="Script" id=3]
[ext_resource path="res://areas/04 - Kuro/jango/(State) Sleep.tscn" type="PackedScene" id=4]

[sub_resource type="GDScript" id=1]
script/source = "extends Node

# targetArray = Array contendo as posições que esse feitiço atingiu
#               A célula central será contida em um Array sozinha, para fácil identificação
var skill
func effects(targetArray):
	skill = get_parent()
	
	BattleMechanics.playAnimEntity(skill.caster,\"Hypno\")
	yield(get_tree().create_timer(0.7),\"timeout\")
	var allcells = BattleMechanics.area.tilemap.get_used_cells()
	var cells = []
	for i in allcells:
		if i == skill.caster.posit:
			cells.append([i])
			continue
		
		if BattleMechanics.directionTo(skill.caster.posit, i) != skill.caster.direction:
			continue
		
		if BattleMechanics.checkSight(skill.caster.posit, i):
			continue
		
		cells.append(i)
	
	cells = BattleMechanics.orderAoE(cells)
	var k = cells.keys()
	k.sort()
	
	var s = true
	for i in k:
		for j in cells[i]:
			BattleMechanics.playAnim(skill.visuals[0],j)
			var tgt = BattleMechanics.getEntityAt(j)
			if tgt and tgt.direction == skill.caster.direction *-1:
				if tgt.player:
					BattleMechanics.bounceTgt(tgt)
					
					BattleMechanics.addState(skill.states[0],tgt,skill.caster,3)
					if s:
						BattleMechanics.addState(skill.states[0],skill.caster,skill.caster,3)
						s = false
				else:
					BattleMechanics.bounceTgt(tgt)
					tgt.turn_to(tgt.direction*-1)
					unturn(tgt)
		#yield(get_tree().create_timer(0.1),\"timeout\")
	yield(get_tree().create_timer(3),\"timeout\")
	
func unturn(tgt):
	yield(get_tree().create_timer(1),\"timeout\")
	BattleMechanics.bounceTgt(tgt)
	tgt.turn_to(tgt.direction*-1)
	
			
	
	
	
"

[node name="Skill" type="Node2D"]
script = ExtResource( 3 )
skillName = "Sleep Hypnosis"
rangeMin = 0
rangeMax = 0
sight = true
usePerTgt = 1
tgtTypeEntity = true
visuals = [ ExtResource( 2 ) ]
effects = SubResource( 1 )
states = [ ExtResource( 4 ) ]
helpertext = [ ExtResource( 1 ) ]

[node name="Effects" type="Node" parent="."]
